version: '3.9'

volumes:
  docker-data: {}

networks:
  app-network:
    driver: bridge

services:
  localstack:
    container_name: "${LOCALSTACK_DOCKER_NAME:-localstack-aws-utils}"
    image: localstack/localstack
    ports:
      - "127.0.0.1:4566:4566"            # LocalStack Gateway
      - "127.0.0.1:4510-4559:4510-4559"  # external services port range
    environment:
      # LocalStack configuration: https://docs.localstack.cloud/references/configuration/
      - CLEAR_TMP_FOLDER=0
      - DEBUG=${DEBUG:-1}
      - PERSISTENCE=${PERSISTENCE:-1}
      - LAMBDA_EXECUTOR=${LAMBDA_EXECUTOR:-}
      - LOCALSTACK_API_KEY=${LOCALSTACK_API_KEY:-}  # only required for Pro
      - SERVICES=s3,lambda,sns,sqs,iam
      - DATA_DIR=/tmp/localstack/data
      - START_WEB=1
      - DOCKER_HOST=unix:///var/run/docker.sock
      - DEFAULT_REGION=us-east-1
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_EXECUTION_ENV=True
      - ENV=${NODE_ENV}
      - AWS_ACCESS_KEY_ID=${LOCALSTACK_ACCESS_KEY_ID:-zzzzzzzzz}
      - AWS_SECRET_ACCESS_KEY=${LOCALSTACK_SECRET_ACCESS_KEY:-zzzzzzzzzzzzzzzzzzzzz}
      - HOSTNAME_EXTERNAL=localhost
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "${VOLUME_DIR_LOCALSTACK:-./docker-data/aws-localstack}:/var/lib/localstack"
      - "${VOLUME_DIR_LOCALSTACK:-./docker-data/aws-localstack}/aws-s3:/tmp/localstack"
      - "${VOLUME_DIR_LOCALSTACK:-./docker-data/aws-localstack}/aws-bootstrap:/opt/bootstrap/"
    networks:
      - app-network